/*-
 * Copyright (c) 2023, Collin Funk
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHORS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 */

/*
 * Test vectors found on Bruce Schneier's site.
 * https://www.schneier.com/academic/blowfish/
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "blowfish.h"

static const uint8_t blowfish_test_keys[34][8] = {
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff},
	{0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	{0x01, 0x23, 0x45, 0x67, 0x89, 0xab, 0xcd, 0xef},
	{0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0xfe, 0xdc, 0xba, 0x98, 0x76, 0x54, 0x32, 0x10},
	{0x7c, 0xa1, 0x10, 0x45, 0x4a, 0x1a, 0x6e, 0x57},
	{0x01, 0x31, 0xd9, 0x61, 0x9d, 0xc1, 0x37, 0x6e},
	{0x07, 0xa1, 0x13, 0x3e, 0x4a, 0x0b, 0x26, 0x86},
	{0x38, 0x49, 0x67, 0x4c, 0x26, 0x02, 0x31, 0x9e},
	{0x04, 0xb9, 0x15, 0xba, 0x43, 0xfe, 0xb5, 0xb6},
	{0x01, 0x13, 0xb9, 0x70, 0xfd, 0x34, 0xf2, 0xce},
	{0x01, 0x70, 0xf1, 0x75, 0x46, 0x8f, 0xb5, 0xe6},
	{0x43, 0x29, 0x7f, 0xad, 0x38, 0xe3, 0x73, 0xfe},
	{0x07, 0xa7, 0x13, 0x70, 0x45, 0xda, 0x2a, 0x16},
	{0x04, 0x68, 0x91, 0x04, 0xc2, 0xfd, 0x3b, 0x2f},
	{0x37, 0xd0, 0x6b, 0xb5, 0x16, 0xcb, 0x75, 0x46},
	{0x1f, 0x08, 0x26, 0x0d, 0x1a, 0xc2, 0x46, 0x5e},
	{0x58, 0x40, 0x23, 0x64, 0x1a, 0xba, 0x61, 0x76},
	{0x02, 0x58, 0x16, 0x16, 0x46, 0x29, 0xb0, 0x07},
	{0x49, 0x79, 0x3e, 0xbc, 0x79, 0xb3, 0x25, 0x8f},
	{0x4f, 0xb0, 0x5e, 0x15, 0x15, 0xab, 0x73, 0xa7},
	{0x49, 0xe9, 0x5d, 0x6d, 0x4c, 0xa2, 0x29, 0xbf},
	{0x01, 0x83, 0x10, 0xdc, 0x40, 0x9b, 0x26, 0xd6},
	{0x1c, 0x58, 0x7f, 0x1c, 0x13, 0x92, 0x4f, 0xef},
	{0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01},
	{0x1f, 0x1f, 0x1f, 0x1f, 0x0e, 0x0e, 0x0e, 0x0e},
	{0xe0, 0xfe, 0xe0, 0xfe, 0xf1, 0xfe, 0xf1, 0xfe},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff},
	{0x01, 0x23, 0x45, 0x67, 0x89, 0xab, 0xcd, 0xef},
	{0xfe, 0xdc, 0xba, 0x98, 0x76, 0x54, 0x32, 0x10}
};

static const uint8_t blowfish_test_plaintexts[34][8] = {
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff},
	{0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01},
	{0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	{0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	{0x01, 0x23, 0x45, 0x67, 0x89, 0xab, 0xcd, 0xef},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x01, 0x23, 0x45, 0x67, 0x89, 0xab, 0xcd, 0xef},
	{0x01, 0xa1, 0xd6, 0xd0, 0x39, 0x77, 0x67, 0x42},
	{0x5c, 0xd5, 0x4c, 0xa8, 0x3d, 0xef, 0x57, 0xda},
	{0x02, 0x48, 0xd4, 0x38, 0x06, 0xf6, 0x71, 0x72},
	{0x51, 0x45, 0x4b, 0x58, 0x2d, 0xdf, 0x44, 0x0a},
	{0x42, 0xfd, 0x44, 0x30, 0x59, 0x57, 0x7f, 0xa2},
	{0x05, 0x9b, 0x5e, 0x08, 0x51, 0xcf, 0x14, 0x3a},
	{0x07, 0x56, 0xd8, 0xe0, 0x77, 0x47, 0x61, 0xd2},
	{0x76, 0x25, 0x14, 0xb8, 0x29, 0xbf, 0x48, 0x6a},
	{0x3b, 0xdd, 0x11, 0x90, 0x49, 0x37, 0x28, 0x02},
	{0x26, 0x95, 0x5f, 0x68, 0x35, 0xaf, 0x60, 0x9a},
	{0x16, 0x4d, 0x5e, 0x40, 0x4f, 0x27, 0x52, 0x32},
	{0x6b, 0x05, 0x6e, 0x18, 0x75, 0x9f, 0x5c, 0xca},
	{0x00, 0x4b, 0xd6, 0xef, 0x09, 0x17, 0x60, 0x62},
	{0x48, 0x0d, 0x39, 0x00, 0x6e, 0xe7, 0x62, 0xf2},
	{0x43, 0x75, 0x40, 0xc8, 0x69, 0x8f, 0x3c, 0xfa},
	{0x07, 0x2d, 0x43, 0xa0, 0x77, 0x07, 0x52, 0x92},
	{0x02, 0xfe, 0x55, 0x77, 0x81, 0x17, 0xf1, 0x2a},
	{0x1d, 0x9d, 0x5c, 0x50, 0x18, 0xf7, 0x28, 0xc2},
	{0x30, 0x55, 0x32, 0x28, 0x6d, 0x6f, 0x29, 0x5a},
	{0x01, 0x23, 0x45, 0x67, 0x89, 0xab, 0xcd, 0xef},
	{0x01, 0x23, 0x45, 0x67, 0x89, 0xab, 0xcd, 0xef},
	{0x01, 0x23, 0x45, 0x67, 0x89, 0xab, 0xcd, 0xef},
	{0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff}
};

static const uint8_t blowfish_test_ciphertexts[34][8] = {
	{0x4e, 0xf9, 0x97, 0x45, 0x61, 0x98, 0xdd, 0x78},
	{0x51, 0x86, 0x6f, 0xd5, 0xb8, 0x5e, 0xcb, 0x8a},
	{0x7d, 0x85, 0x6f, 0x9a, 0x61, 0x30, 0x63, 0xf2},
	{0x24, 0x66, 0xdd, 0x87, 0x8b, 0x96, 0x3c, 0x9d},
	{0x61, 0xf9, 0xc3, 0x80, 0x22, 0x81, 0xb0, 0x96},
	{0x7d, 0x0c, 0xc6, 0x30, 0xaf, 0xda, 0x1e, 0xc7},
	{0x4e, 0xf9, 0x97, 0x45, 0x61, 0x98, 0xdd, 0x78},
	{0x0a, 0xce, 0xab, 0x0f, 0xc6, 0xa0, 0xa2, 0x8d},
	{0x59, 0xc6, 0x82, 0x45, 0xeb, 0x05, 0x28, 0x2b},
	{0xb1, 0xb8, 0xcc, 0x0b, 0x25, 0x0f, 0x09, 0xa0},
	{0x17, 0x30, 0xe5, 0x77, 0x8b, 0xea, 0x1d, 0xa4},
	{0xa2, 0x5e, 0x78, 0x56, 0xcf, 0x26, 0x51, 0xeb},
	{0x35, 0x38, 0x82, 0xb1, 0x09, 0xce, 0x8f, 0x1a},
	{0x48, 0xf4, 0xd0, 0x88, 0x4c, 0x37, 0x99, 0x18},
	{0x43, 0x21, 0x93, 0xb7, 0x89, 0x51, 0xfc, 0x98},
	{0x13, 0xf0, 0x41, 0x54, 0xd6, 0x9d, 0x1a, 0xe5},
	{0x2e, 0xed, 0xda, 0x93, 0xff, 0xd3, 0x9c, 0x79},
	{0xd8, 0x87, 0xe0, 0x39, 0x3c, 0x2d, 0xa6, 0xe3},
	{0x5f, 0x99, 0xd0, 0x4f, 0x5b, 0x16, 0x39, 0x69},
	{0x4a, 0x05, 0x7a, 0x3b, 0x24, 0xd3, 0x97, 0x7b},
	{0x45, 0x20, 0x31, 0xc1, 0xe4, 0xfa, 0xda, 0x8e},
	{0x75, 0x55, 0xae, 0x39, 0xf5, 0x9b, 0x87, 0xbd},
	{0x53, 0xc5, 0x5f, 0x9c, 0xb4, 0x9f, 0xc0, 0x19},
	{0x7a, 0x8e, 0x7b, 0xfa, 0x93, 0x7e, 0x89, 0xa3},
	{0xcf, 0x9c, 0x5d, 0x7a, 0x49, 0x86, 0xad, 0xb5},
	{0xd1, 0xab, 0xb2, 0x90, 0x65, 0x8b, 0xc7, 0x78},
	{0x55, 0xcb, 0x37, 0x74, 0xd1, 0x3e, 0xf2, 0x01},
	{0xfa, 0x34, 0xec, 0x48, 0x47, 0xb2, 0x68, 0xb2},
	{0xa7, 0x90, 0x79, 0x51, 0x08, 0xea, 0x3c, 0xae},
	{0xc3, 0x9e, 0x07, 0x2d, 0x9f, 0xac, 0x63, 0x1d},
	{0x01, 0x49, 0x33, 0xe0, 0xcd, 0xaf, 0xf6, 0xe4},
	{0xf2, 0x1e, 0x9a, 0x77, 0xb7, 0x1c, 0x49, 0xbc},
	{0x24, 0x59, 0x46, 0x88, 0x57, 0x54, 0x36, 0x9a},
	{0x6b, 0x5c, 0x5a, 0x9c, 0x5d, 0x9e, 0x0a, 0x5a}
};

static void hexdump(const uint8_t *, size_t);
static int run_blowfish_tests(void);

int
main(void)
{
	if (run_blowfish_tests() < 0)
		exit(1);

	return 0;
}

static void
hexdump(const uint8_t *data, size_t len)
{
	size_t i;
	for (i = 0; i < len; ++i)
		printf("%02x", data[i]);
	printf("\n");
}

static int
run_blowfish_tests(void)
{
	int i;
	int rv;
	struct blowfish_ctx ctx;
	const uint8_t *p, *c, *k;
	uint8_t buffer1[8];
	uint8_t buffer2[8];

	for (i = rv = 0; i < 34; ++i) {
		k = blowfish_test_keys[i];
		p = blowfish_test_plaintexts[i];
		c = blowfish_test_ciphertexts[i];
		printf("Blowfish test %d:\n", i);
		printf("  Key:       ");
		hexdump(k, 8);
		printf("  Plain:     ");
		hexdump(p, 8);
		printf("  Cipher:    ");
		hexdump(c, 8);

		blowfish_set_key(&ctx, k, 8);
		blowfish_ecb_encrypt(&ctx, p, buffer1, 8);
		printf("  Got:       ");
		hexdump(buffer1, 8);
		if (memcmp(buffer1, c, 8) != 0) {
			printf("Test %d failed.\n", i);
			rv = -1;
			continue;
		}
		blowfish_ecb_decrypt(&ctx, buffer1, buffer2, 8);
		printf("  Decrypted: ");
		hexdump(buffer2, 8);
		if (memcmp(buffer2, p, 8) != 0) {
			printf("Test %d failed.\n", i);
			rv = -1;
			continue;
		}
	}

	return rv;
}

